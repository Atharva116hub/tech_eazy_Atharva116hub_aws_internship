name: EC2 App Deployment with Terraform

on:
  push:
    branches:
      - main
    paths:
      - 'main.tf'
      - 'variables.tf'
      - 'outputs.tf'
      - 'versions.tf'
      - 'templates/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      stage:
        description: 'Deployment Stage (Dev or Prod)'
        required: true
        default: 'Dev'
        type: choice
        options:
          - Dev
          - Prod
      destroy:
        description: 'Destroy infrastructure after deployment/validation?'
        required: true
        default: 'true'
        type: boolean

env:
  TF_VAR_stage: ${{ github.event.inputs.stage || 'Dev' }}
  TF_VAR_region: 'ap-northeast-2'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.TF_VAR_region }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.x

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        run: terraform apply -var="stage=${{ env.TF_VAR_stage }}" -auto-approve

      - name: Get Outputs
        id: get_ip
        run: |
          echo "EC2_PUBLIC_IP=$(terraform output -raw instance_public_ip)" >> $GITHUB_ENV
          echo "APP_URL=$(terraform output -raw app_url)" >> $GITHUB_ENV

      - name: Wait and Validate App URL
        run: |
          echo "Waiting for app to start at $APP_URL..."
          for i in $(seq 1 10); do
            if curl -s -f $APP_URL; then
              echo "Application is up and running!"
              exit 0
            fi
            echo "Attempt $i: App not ready yet. Waiting 10 seconds..."
            sleep 10
          done
          echo "Application did not become ready within the expected time."
          exit 1
        timeout-minutes: 5

      - name: Terraform Destroy
        if: ${{ github.event.inputs.destroy == 'true' }}
        run: terraform destroy -var="stage=${{ env.TF_VAR_stage }}" -auto-approve
